name: Beta Build

on:
  workflow_dispatch:

permissions:
  contents: write
  issues: read

jobs:
  beta-release:
    runs-on: ubuntu-latest
    env:
      # No CF_API_KEY or WAGO_API_TOKEN - packager skips those uploads.
      # Packager runs with -d (skip upload) so only builds the zip.
      GITHUB_OAUTH: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Extract [Unreleased] from CHANGELOG for release notes
        id: changelog
        run: |
          # Read [Unreleased] section (between ## [Unreleased] and ---)
          BODY=$(python3 -c "
          import re
          content = open('CHANGELOG.md').read()
          match = re.search(r'## \[Unreleased\]\s*\n\n(.*?)(?=\n---\n)', content, re.DOTALL)
          raw = match.group(1).strip() if match else ''
          # Use placeholder if empty or just the HTML comment
          if not raw or 'Changelog entries are generated' in raw:
            print('Rolling beta from **main**. Download the zip below.')
          else:
            print('Rolling beta from **main**.' + chr(10) + chr(10) + '## Recent changes' + chr(10) + chr(10) + raw)
          ")
          echo "changelog<<CHANGELOG_EOF" >> $GITHUB_OUTPUT
          printf '%s\n' "$BODY" >> $GITHUB_OUTPUT
          echo "CHANGELOG_EOF" >> $GITHUB_OUTPUT

          printf '%s' "$BODY" | jq -Rs 'if length > 4096 then .[0:4096] else . end' > /tmp/changelog-desc.json
          REPO_NAME="${GITHUB_REPOSITORY##*/}"
          jq -n \
            --arg user "Addon Beta Bot" \
            --arg avatar "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" \
            --arg title "New Beta Build: ${REPO_NAME}" \
            --arg url "https://github.com/${GITHUB_REPOSITORY}/releases/tag/beta" \
            --arg fallback "Rolling beta from **main**. Download the zip below." \
            --slurpfile desc /tmp/changelog-desc.json \
            '{username: $user, avatar_url: $avatar, embeds: [{title: $title, url: $url, description: (if $desc[0] then $desc[0] else $fallback end)}]}' \
            > /tmp/discord-payload.json

      - name: Use beta pkgmeta
        run: cp .pkgmeta.beta .pkgmeta

      - name: Package addon (build only)
        uses: BigWigsMods/packager@v2.5.1
        with:
          args: -d

      - name: Prepare zip and Discord payload
        run: |
          ZIP=$(ls .release/*.zip 2>/dev/null | head -1)
          if [ -z "$ZIP" ]; then echo "No zip found in .release/"; exit 1; fi
          cp "$ZIP" .release/HorizonSuite-beta.zip
          cp /tmp/discord-payload.json .release/discord-payload.json

      - name: Create or update Beta release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHANGELOG: ${{ steps.changelog.outputs.changelog }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f beta
          git push origin refs/tags/beta --force
          gh release delete beta -y || true
          printf '%s' "$CHANGELOG" > /tmp/changelog.md
          gh release create beta .release/HorizonSuite-beta.zip --title "Beta" --notes-file /tmp/changelog.md --prerelease

      - name: Post to Discord
        continue-on-error: true
        uses: tsickert/discord-webhook@v5.3.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK_BETA }}
          raw-data: .release/discord-payload.json
