name: Relabel Issues

on:
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  relabel:
    runs-on: ubuntu-latest
    steps:
      - name: Relabel all open issues
        uses: actions/github-script@v7
        with:
          script: |
            const renames = {
              'module:Focus': 'Focus',
              'module:Presence': 'Presence',
              'module:Core': 'Core',
              'module:Vista': 'Vista',
              'module:Yield': 'Yield',
              'module:Pulse': 'Pulse',
              'module:Essence': 'Essence',
              'module:Insight': 'Insight',
              'module:Verse': 'Verse',
              'priority:P0': 'Priority 0',
              'priority:P1': 'Priority 1',
              'priority:P2': 'Priority 2',
            };

            const oldNames = Object.keys(renames);
            let page = 1;
            let updated = 0;

            while (true) {
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
                per_page: 100,
                page,
              });
              if (issues.length === 0) break;

              for (const issue of issues) {
                if (issue.pull_request) continue;
                const currentLabels = issue.labels.map(l => l.name);
                const toRemove = currentLabels.filter(n => oldNames.includes(n));
                if (toRemove.length === 0) continue;

                const toAdd = toRemove.map(n => renames[n]);
                const newLabels = currentLabels
                  .filter(n => !oldNames.includes(n))
                  .concat(toAdd);

                await github.rest.issues.setLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  labels: newLabels,
                });
                console.log(`#${issue.number}: ${toRemove.join(', ')} -> ${toAdd.join(', ')}`);
                updated++;
              }
              page++;
            }
            console.log(`Done. Updated ${updated} issues.`);
